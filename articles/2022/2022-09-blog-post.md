---
date: '2022-09-25T12:15:00.077+01:00'
description: ''
published: true
slug: 2022-09-blog-post
tags:
- http://schemas.google.com/blogger/2008/kind#post
- legacy-blogger
time_to_read: 5
title: "\u56FD\u5185IP\u672A\u5907\u6848 \u514D\u8D39Cloudflare CDN\u7684\u66F2\u7EBF\
  \u5C0F\u65B9\u6848 \uFF08Deno&Cloudflare\uFF09\u548C\u5176\u5B83\u7684\u4E00\u4E9B\
  \u5C0F\u65B9\u6848/\u8BB0\u5F55"
---

*This was originally posted on blogger [here](https://sheng-jiang.blogspot.com/2022/09/blog-post.html)*.

<p>引子：由于大陆网络环境问题，有很多问题得绕“曲线”才能达成目的。亦或是通过“曲线”来节省成本。&nbsp;</p><p>------------------------------------------------------------------------------------------------------------------------</p><div><span style="font-size: xx-small;">这一段是20221023更新的，写这文章的功夫都超过调试的过程了。</span></div><div><br /></div><div><br /></div><div><span style="color: #ea9999; font-size: large;">最新更新</span>：<b>大大的减少部署时间和难度，只要一个<i>Deno</i>项目和一个<i>Cloudflare</i>项目，就可以无限加域名。</b><span style="font-size: xx-small;">获取版本&nbsp;<a href="https://github.com/JacquesVonHamsterviel/Javascript_Reverse_Proxy_IP-Port" target="_blank"><i>GitHub</i></a></span></div><div><br /></div><div>效果：</div><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjbuOu5WP0vv4tjrscMOpx2OGUDRZyouGdeoTJHgvr6Tfrorcjh3rLh8iH_p-ejz6BnDJ_kuHSq04H1X-xxbVihKPfQrfJxfs39GoqZNx5OTTa6TADEY4mUiTdIF3Tgq0jEOJ_tny_dKFGuCasKXYuuKDxH_UavvECu-qp48i0BiE6zYBorcYgrcp7d/s1988/demo.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="221" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjbuOu5WP0vv4tjrscMOpx2OGUDRZyouGdeoTJHgvr6Tfrorcjh3rLh8iH_p-ejz6BnDJ_kuHSq04H1X-xxbVihKPfQrfJxfs39GoqZNx5OTTa6TADEY4mUiTdIF3Tgq0jEOJ_tny_dKFGuCasKXYuuKDxH_UavvECu-qp48i0BiE6zYBorcYgrcp7d/s320/demo.png" width="320" /></a></div><div style="text-align: center;"><span>&nbsp;<i>Deno</i></span><br /></div><div>这线路可是真复杂：<span style="font-size: x-small;">（内网《=》<i>阿里云</i>）《=》<i>Deno</i>《=》<i>Cloudflare workers</i>《=》<i>Cloudflare</i></span><span style="font-size: small;">《</span><span style="font-size: small;">=》访问者。</span></div><div><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhaiy8RZCnWR_Kj_hyKcClI00oPPdGWb_pNULt2Wp8rzHi84EpEGE5CSENVYIADCbRJIuZxhVZ1GA7jJa5vjZJ5GpxGO9zc7EIxpo0W9BFmVXMmyEPCbNr9KblmPUcoOUe882ezO76trwgDQ09-3qJq3qbcMPx4f5sUpQDB1QgKAJHQ9OYwEboUDFSE/s1074/httping.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="291" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhaiy8RZCnWR_Kj_hyKcClI00oPPdGWb_pNULt2Wp8rzHi84EpEGE5CSENVYIADCbRJIuZxhVZ1GA7jJa5vjZJ5GpxGO9zc7EIxpo0W9BFmVXMmyEPCbNr9KblmPUcoOUe882ezO76trwgDQ09-3qJq3qbcMPx4f5sUpQDB1QgKAJHQ9OYwEboUDFSE/s320/httping.png" width="320" /></a></div><div style="text-align: center;"><span style="font-size: xx-small;">httping <i>Cloudflare</i>代理后：正常中美线路个人感觉这延迟已经非常好了，何况还是这么得曲线</span></div><div style="text-align: center;"><span style="font-size: xx-small;"><br /></span></div><div style="text-align: center;"><span style="font-size: xx-small;"><br /></span></div><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiVrWBDOuyfABmoc6WrvSg-TjpSMsR2Ts4e3LF69yb-uaEr_1-VSp_YexgDgIg0OJsgfd2IU5EJ70ZJTVLUmAOw5016BunY_c9selO14H92q2kDaWcDaXCMppLpCImXDIv3PWHC5ZdtJac4LeqwdAw2CHH2FftYtjFowoy1_hqN-5PY6YduJEU7EZhi/s1010/cf-cn.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="206" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiVrWBDOuyfABmoc6WrvSg-TjpSMsR2Ts4e3LF69yb-uaEr_1-VSp_YexgDgIg0OJsgfd2IU5EJ70ZJTVLUmAOw5016BunY_c9selO14H92q2kDaWcDaXCMppLpCImXDIv3PWHC5ZdtJac4LeqwdAw2CHH2FftYtjFowoy1_hqN-5PY6YduJEU7EZhi/s320/cf-cn.png" width="320" /></a></div><div style="text-align: center;"><div><span style="font-size: xx-small;">httping 电信公网IP转发到<i>Deno</i>再到<i>Cloudflare</i>的网页</span></div><div><span style="font-size: xx-small;"><br /></span></div></div><div style="text-align: center;"><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEii3xVXOhcXOr-SDFDJHXNh3oBywcKTD54cj_Npg_7MVPI7pxaebWc8cgbxnfHqGXjFcroP__iwbSePcinIK2pT1F2SyPVkZppR8ljefWX07sTfV7oClKBJNQtuH0euHEp0PLcMld0Mopv_ZP1_Q0hP-vg7piaFVSp2MY-zSe57Hh04ynMfywzj2kfG/s618/deno-cn.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="307" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEii3xVXOhcXOr-SDFDJHXNh3oBywcKTD54cj_Npg_7MVPI7pxaebWc8cgbxnfHqGXjFcroP__iwbSePcinIK2pT1F2SyPVkZppR8ljefWX07sTfV7oClKBJNQtuH0euHEp0PLcMld0Mopv_ZP1_Q0hP-vg7piaFVSp2MY-zSe57Hh04ynMfywzj2kfG/s320/deno-cn.png" width="320" /></a></div><span style="font-size: xx-small;"><br /></span></div><div style="text-align: center;"><span style="font-size: xx-small;">httping 电信公网IP转发到Deno的网页</span></div><div>速度：由于阿里云只有5Mbps，所以只能跑到5Mbps，但是稳定性非常好。</div><div>不管是国内直连<i>Deno</i>还<i>Cloudflare</i>都是能跑满阿里云的带宽。</div><div style="text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjazK_d65B_v8PMDvfhopsazIXwo6oLDgpbDM_dhZFQwsJSwX1_aI5kzxD6AW-JQmiepvLsw4GxL-VA6D7Av0f8bEk5JMynJ0Py0mdb13qZTlHpvfTdseLlTY-ZycoJYzkylHj4OA8YYkvfv0rZYDlWD56e7HXoUEHsJlWQfg4j-C2b_3lX-0hSIkPq/s896/deno-download-cn.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="90" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjazK_d65B_v8PMDvfhopsazIXwo6oLDgpbDM_dhZFQwsJSwX1_aI5kzxD6AW-JQmiepvLsw4GxL-VA6D7Av0f8bEk5JMynJ0Py0mdb13qZTlHpvfTdseLlTY-ZycoJYzkylHj4OA8YYkvfv0rZYDlWD56e7HXoUEHsJlWQfg4j-C2b_3lX-0hSIkPq/s320/deno-download-cn.png" width="320" /></a></div><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgqMTbmSJEtCVet-xL4KNS9nbeoqBbsdQE5KRocz85Uhf0dLbst_gBKavIkSXjsYmGnyh5bTRKyXvXW_BiV9LpSZwYLMwViJga1al8gcuvhYO133v5NNg5ZmkySGTaIgiAKDPaZ5gpd7ForK6OTWct842ppBQLkjtiZMYpffgc5_Q9au5aQr9vtN5EP/s814/deno-upload-cn.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="206" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgqMTbmSJEtCVet-xL4KNS9nbeoqBbsdQE5KRocz85Uhf0dLbst_gBKavIkSXjsYmGnyh5bTRKyXvXW_BiV9LpSZwYLMwViJga1al8gcuvhYO133v5NNg5ZmkySGTaIgiAKDPaZ5gpd7ForK6OTWct842ppBQLkjtiZMYpffgc5_Q9au5aQr9vtN5EP/s320/deno-upload-cn.png" width="320" /></a></div><div style="text-align: center;"><br /></div><div style="text-align: center;"><span style="font-size: xx-small;">30Mbps上传/200Mbps下载的电信带公网IP转发通过<i>Deno</i>在国内访问的速度</span></div><div style="text-align: center;"><span style="font-size: xx-small;"><br /></span></div><div style="text-align: center;"><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgMe_Gq79Dw3VSP6z_jd7bfoqYwEAtttUtKZt_5tWKHOG3cUH6iI5xHKO6jl0vBttfItzYXGxJ6mYEPf7m3m3DmjHySUOxWj_5UMBPiWPkkPdxO5zCrMkhOCLpk42i1oj1xVY8q421QWatWqE0A4uVA3K9npP_l7vhScUb4abAFO1p66Vf-lWENhrb6/s2500/deno-download-uk.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="93" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgMe_Gq79Dw3VSP6z_jd7bfoqYwEAtttUtKZt_5tWKHOG3cUH6iI5xHKO6jl0vBttfItzYXGxJ6mYEPf7m3m3DmjHySUOxWj_5UMBPiWPkkPdxO5zCrMkhOCLpk42i1oj1xVY8q421QWatWqE0A4uVA3K9npP_l7vhScUb4abAFO1p66Vf-lWENhrb6/s320/deno-download-uk.png" width="320" /></a></div><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg2ctAsguY-U0-lTvRxq8xcRykFDB56-8p9I19ApfOO1P3hZHJioOuPQ-A0RTavj9fRTF9sng5QHDBjA1bsLef5H_ivEQJAjzs1H38eVpa2TV8yh3iztshklBBJbOSVvJtluegyGCBRdnsMQUVFm_GTq6Kgpleq6TNb28seeLfFrpQ7vSrbN1ijEtLZ/s2782/deno-upload-uk.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="128" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg2ctAsguY-U0-lTvRxq8xcRykFDB56-8p9I19ApfOO1P3hZHJioOuPQ-A0RTavj9fRTF9sng5QHDBjA1bsLef5H_ivEQJAjzs1H38eVpa2TV8yh3iztshklBBJbOSVvJtluegyGCBRdnsMQUVFm_GTq6Kgpleq6TNb28seeLfFrpQ7vSrbN1ijEtLZ/s320/deno-upload-uk.png" width="320" /></a></div><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjJyaZY9f8qEUZydhAQSFaAw3OCKSj_5TFzvKvI8napUyRP07r0_Clv1d9_I8aXizJoonblmqh7KSvcxn4clbyAN4FRfOVdgT_tGUjqdEKKeHFCZLo6_P37-zJQv5Og8l2gEsmepypfAV0MJfdO1roK2fz33BNdy8c2uvEjAsBLtgmGxogifDQsUhxH/s1298/deno-upload-uk-2.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="247" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjJyaZY9f8qEUZydhAQSFaAw3OCKSj_5TFzvKvI8napUyRP07r0_Clv1d9_I8aXizJoonblmqh7KSvcxn4clbyAN4FRfOVdgT_tGUjqdEKKeHFCZLo6_P37-zJQv5Og8l2gEsmepypfAV0MJfdO1roK2fz33BNdy8c2uvEjAsBLtgmGxogifDQsUhxH/s320/deno-upload-uk-2.png" width="320" /></a></div><div class="separator" style="clear: both; text-align: center;"><br /></div><span style="font-size: xx-small;"><br /></span></div><div style="text-align: center;"><span style="font-size: xx-small;">30Mbps上传/200Mbps下载的电信带公网IP转发通过<i>Deno</i>在国外访问的速度</span></div><div style="text-align: center;"><span style="font-size: xx-small;"><br /></span></div><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhihVDYKEw-z4Yq5DIWsxYEY1FdMDG6Ae_y24ystjNPrtC3nvD18a6EImeXbspCHtN3cO3FiBXtUDgG0QicdxmUpEzijTf1VNjR-s4dfNoAeZHxhvODvWU9bl3hod1h8Yuijp7C5cyTdOisKXXOcDMgYZab4BC5Aqyt3yYegXgbJpeBFf_s4QnZsWeP/s826/cf-download-cn.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="107" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhihVDYKEw-z4Yq5DIWsxYEY1FdMDG6Ae_y24ystjNPrtC3nvD18a6EImeXbspCHtN3cO3FiBXtUDgG0QicdxmUpEzijTf1VNjR-s4dfNoAeZHxhvODvWU9bl3hod1h8Yuijp7C5cyTdOisKXXOcDMgYZab4BC5Aqyt3yYegXgbJpeBFf_s4QnZsWeP/s320/cf-download-cn.png" width="320" /></a></div><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgF5TdlgXT-2XWWGA2ckJ7SZi8SDtfklojNiXofFalTP7FcdOoKz6HUCflaNRaQd6GYX8KgmXkgX3mTICYRSKYfYw5-t_OioyZYyBof5t-KLEzGoAUePTYM7_mWvTKwUYXeHcgzpqYdT-VkAwmaah1aInCcSc5LB07ekDTBpwyXLzvrglCCre77k0HG/s1028/cf-upload-cn.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="83" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgF5TdlgXT-2XWWGA2ckJ7SZi8SDtfklojNiXofFalTP7FcdOoKz6HUCflaNRaQd6GYX8KgmXkgX3mTICYRSKYfYw5-t_OioyZYyBof5t-KLEzGoAUePTYM7_mWvTKwUYXeHcgzpqYdT-VkAwmaah1aInCcSc5LB07ekDTBpwyXLzvrglCCre77k0HG/s320/cf-upload-cn.png" width="320" /></a></div><div style="text-align: center;"><br /></div><div style="text-align: center;"><span><span style="font-size: x-small;">30Mbps上传/200Mbps下载</span><span style="font-size: xx-small;">的电信带公网IP转发通过<i>Deno</i>和<i>Cloudflare</i>在国内访问的速度</span></span></div><div style="text-align: center;"><div><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgmeWK6Sfnoy8LTVS136BhP6wQADmbLHJ3W_xfBckhZUVCCPjm7UPXGuF0x-XXkng1dDHr8vo2eHOP4ZKxEJ0RXUqayrIPCnwTajELzm-eHgyPK2mihogRTt_Ol9_Ztdg9IZxyhWPZyIsQxBWGnc-y7TGGUpXzentEgN5p6CaY-gp1A0Zado1_Sdj6N/s2516/cf-uk-download.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="98" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgmeWK6Sfnoy8LTVS136BhP6wQADmbLHJ3W_xfBckhZUVCCPjm7UPXGuF0x-XXkng1dDHr8vo2eHOP4ZKxEJ0RXUqayrIPCnwTajELzm-eHgyPK2mihogRTt_Ol9_Ztdg9IZxyhWPZyIsQxBWGnc-y7TGGUpXzentEgN5p6CaY-gp1A0Zado1_Sdj6N/s320/cf-uk-download.png" width="320" /></a></div><br /><span style="font-size: xx-small;"><br class="Apple-interchange-newline" /><br /></span></div><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjySjW3wOdD7jLled50UjOML42iTQCgD_-qCT6qKbJ2ew9kycHvB0QY0YHh0waIn-ay2l7a4CGWWeQUq1AZfe5MxU2XOwQhPTFpzZrzasUS-AjHIbfFe8u80gx0NB_4I2ITWmghme0nNAYjWU0nMONwHJAMWhtvKfgC47fyYJCxoIdgywwLxPxLpVsS/s2188/cf-uk-upload.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="130" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjySjW3wOdD7jLled50UjOML42iTQCgD_-qCT6qKbJ2ew9kycHvB0QY0YHh0waIn-ay2l7a4CGWWeQUq1AZfe5MxU2XOwQhPTFpzZrzasUS-AjHIbfFe8u80gx0NB_4I2ITWmghme0nNAYjWU0nMONwHJAMWhtvKfgC47fyYJCxoIdgywwLxPxLpVsS/s320/cf-uk-upload.png" width="320" /></a></div><br /><div><span style="font-size: x-small;">30Mbps上传/200Mbps下载</span><span style="font-size: xx-small;">的电信带公网IP转发通过<i>Deno</i>和<i>Cloudflare</i>在国外访问的速度</span></div><div><span style="font-size: xx-small;"><br /></span></div><div><b><span style="font-size: x-small;">这样看来电信的瓶颈就在于上传带宽了</span></b></div></div><div>小问题的解释：</div><div><span style="font-size: small;">1. 为什么不直接用<i>Deno</i>：其实域名直接绑在<i>Deno</i>也可，但是还是喜欢<i>Cloudflare</i>的，因为这类域名比较容易被墙，但是目前<i>Deno</i>国内没什么人用，所以还没被墙。而且<i>Deno</i>有写不允许Proxy or VPN，所以用的人都很闷声，我blog写这也不会被收录。之前<i>Cloudflare Workers</i>（<i>workers.dev</i>）没被墙的时候，分享给别人订阅转换，后来被墙了影响非常大。</span></div><div><span style="font-size: small;">2. 为什么不能直接用</span><span style="font-size: small;"><i>Cloudflare Workers</i>：</span><span style="font-size: small;"><i>Cloudflare Workers</i></span><span style="font-size: small;">不能fetch ip，所以需要<i>Deno</i>。</span></div><div><span style="font-size: small;">3. 为什么不直接找台国外机器<i>nginx</i>反代下：要多花钱，如果线路好我还要阿里云干什么。领免费机器的事都是不稳定的，我需要搭好了就一直用就行。<i>阿里云</i>&amp;<i>Deno</i>&amp;<i>Cloudflare</i>都有这个保障。</span></div><div><span style="font-size: small;">4. 为什么不备案：就是不备案。</span></div><div>局限性：</div><div>1. 这个方法不是所有网站都可以反代，经过小小的测试，成功显示并能登录的页面是：<i>nps</i>管理界面&amp;<i>WebDAV</i>&amp;<i>File Browser</i>。失败的是：<i>jellyfin</i>（<span style="font-size: xx-small;">不知道原因，无法正常显示，可能是前端框架的问题</span>），<i>Typecho</i>（可以显示文章，但是登录/搜索框/评论无法使用，因为每次post完了都是返回302跳转，导致&nbsp;Fetch failed: Can not redeliver a streaming request body after a redirect）</div><div>2. Requests的方法只写了get和post，已经够用了，<i>Deno</i>其它的好像也不支持。</div><div>3. <i>Deno</i>的限制：禁止Proxy or VPN，虽然这么写，但是感觉没审查。不过感觉要是一直下载可能会有问题。CPU Time per request是10 ms。官网写了：<span style="font-size: xx-small;">No uptime guarantees are provided during the initial public beta for Deno Deploy. Access to the service will be controlled by our fair use policy. Any user we deem to be in violation of this policy, runs the risk of having their account terminated.</span></div><div><span style="font-size: xx-small;"><br /></span></div><div><span style="font-size: xx-small;">During the initial public beta, the following hard limits apply. If any runtime limits are exceeded, all related requests will be immediately terminated, and a warning will be logged to the deployment's logs.</span></div><div>虽然这样了，先用着吧，大不了换个账号，减少用量。刚刚去看了下Log，即使在下载的时候，isolate start time都在5ms内。</div><div>4. 上传：文件大小限制，<i>Cloudflare</i>在100MB以内，超出就413了。CPU Time 上传下载大文件会超，这个需要注意。</div><div><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjHnPZWWosLk4r6howu2rSAoCDR4H8n7P848vgQeSYhdN20LsWTgZn_5l6bVUoXA6ZSJHxIAEkYl2Ag3_yEzchHFf1fetg_SkJ_aluv-QqLseT9Szw7Cz_D9ZcA2eeKSIdaaMrwYgbBk7LfPA46CMMXtwxXHILpBOVJto2tWx8K7PkGNJLGe0OWlzK1/s1072/cpu-time.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="41" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjHnPZWWosLk4r6howu2rSAoCDR4H8n7P848vgQeSYhdN20LsWTgZn_5l6bVUoXA6ZSJHxIAEkYl2Ag3_yEzchHFf1fetg_SkJ_aluv-QqLseT9Szw7Cz_D9ZcA2eeKSIdaaMrwYgbBk7LfPA46CMMXtwxXHILpBOVJto2tWx8K7PkGNJLGe0OWlzK1/s320/cpu-time.png" width="320" /></a></div><div class="separator" style="clear: both; text-align: center;"><span style="font-size: xx-small;">测试NAS上传下载的时候，有看到一次超的</span></div><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgbzHa9qIm51LAL-2J1co-nVT2VvNlfDPvqba7lGDUA6CrT4yyqSQR2V69ldyOVfG6S9FOAwqrF6zm6GP1STR5pEIOmduPUGQG0gRaR2msKy5cUDb5M3AssYty8ejUBAcc3aBkvFRn4zqMOUPkAlX0kgPM8jXyDxdQTmcZ2f1GefDpxSwcCKyBDJXsi/s604/cf-log.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="111" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgbzHa9qIm51LAL-2J1co-nVT2VvNlfDPvqba7lGDUA6CrT4yyqSQR2V69ldyOVfG6S9FOAwqrF6zm6GP1STR5pEIOmduPUGQG0gRaR2msKy5cUDb5M3AssYty8ejUBAcc3aBkvFRn4zqMOUPkAlX0kgPM8jXyDxdQTmcZ2f1GefDpxSwcCKyBDJXsi/s320/cf-log.png" width="320" /></a></div><div class="separator" style="clear: both; text-align: center;"><span style="font-size: xx-small;"><i>Cloudflare</i>还算正常</span></div><div><span style="color: #2b00fe; font-size: large;">程式</span>（注意：阿里云http不能用域名访问，所以用ip+port即可，https不知道）</div><div><span style="font-size: xx-small;">最初版</span></div><div><span style="color: red;">Deno&nbsp; (Media Type 注意选JS)</span>：</div><div><div><span style="font-size: xx-small;">const upstream = 'ip:port' <span style="color: #ffa400;">//电脑端域名</span></span></div><div><span style="font-size: xx-small;">const upstream_mobile = 'ip:port' <span style="color: #ffa400;">//移动端域名</span></span></div><div><span style="color: #ffa400; font-size: xx-small;">//下面的replace_dict里：xxx.<i>deno,dev</i>要改，其它的可以看需求添加</span></div><div><span style="font-size: xx-small;">const replace_dict = {</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; '$upstream': '$custom_domain',</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; '//google.com': '',</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; 'http://xxx.deno.dev':'https://xxx.deno.dev',</span></div><div><span style="font-size: xx-small;">}</span></div><div><span style="font-size: xx-small;">addEventListener('fetch', event =&gt; {</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; event.respondWith(fetchAndApply(event.request));</span></div><div><span style="font-size: xx-small;">})</span></div><div><span style="font-size: xx-small;">async function fetchAndApply(request) {</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; const user_agent = request.headers.get('user-agent');</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; let response = null;</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; let url = new URL(request.url);</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; let url_host = url.host;</span></div><div><span style="font-size: xx-small;">&nbsp;</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; if (await device_status(user_agent)) {</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; var upstream_domain = upstream</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; } else {</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; var upstream_domain = upstream_mobile</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; }</span></div><div><span style="font-size: xx-small;">&nbsp;</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; url.host = upstream_domain;</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; let method = request.method;</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; let request_headers = request.headers;</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; let new_request_headers = new Headers(request_headers);</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; url.href=url.href.replace('https://','http://');</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; if (request.method === 'POST') {</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; new_request_headers.set('Host', upstream_domain);</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; new_request_headers.set('Referer', url.href);</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; new_request_headers.set('Origin', "http://"+upstream);</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; var original_response = await fetch(url.href, {</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; method: 'POST',</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; headers: new_request_headers,</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; body : request.body</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; })</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; }</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; else{</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; new_request_headers.set('Host', upstream_domain);</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; new_request_headers.set('Referer', url.href);</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp;&nbsp;</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; var original_response = await fetch(url.href, {</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; method: method,</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; headers: new_request_headers</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; })</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; }</span></div><div><span style="font-size: xx-small;"><br /></span></div><div><span style="font-size: xx-small;"><br /></span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; let original_response_clone = original_response.clone();</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; let original_text = null;</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; let response_headers = original_response.headers;</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; let new_response_headers = new Headers(response_headers);</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; let status = original_response.status;</span></div><div><span style="font-size: xx-small;"><br /></span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; new_response_headers.set('access-control-allow-origin', '*');</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; new_response_headers.set('access-control-allow-credentials', true);</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; new_response_headers.delete('content-security-policy');</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; new_response_headers.delete('content-security-policy-report-only');</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; new_response_headers.delete('clear-site-data');</span></div><div><span style="font-size: xx-small;"><br /></span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; const content_type = new_response_headers.get('content-type');</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; if (content_type==null){original_text = original_response_clone.body}</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; else if (content_type.includes('text/html') &amp;&amp; content_type.includes('UTF-8')) {</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; original_text = await replace_response_text(original_response_clone, upstream_domain, url_host);</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; } else {</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; original_text = original_response_clone.body</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; }</span></div><div><span style="font-size: xx-small;"><br /></span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; response = new Response(original_text, {</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; status,</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; headers: new_response_headers</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; })</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp;&nbsp;</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; return response;</span></div><div><span style="font-size: xx-small;"><br /></span></div><div><span style="font-size: xx-small;">&nbsp;</span></div><div><span style="font-size: xx-small;">}</span></div><div><span style="font-size: xx-small;"><br /></span></div><div><span style="font-size: xx-small;"><br /></span></div><div><span style="font-size: xx-small;">async function replace_response_text(response, upstream_domain, host_name) {</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; let text = await response.text()</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; var i, j;</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; for (i in replace_dict) {</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; j = replace_dict[i]</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; if (i == '$upstream') {</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i = upstream_domain</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; } else if (i == '$custom_domain') {</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i = host_name</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; }</span></div><div><span style="font-size: xx-small;">&nbsp;</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; if (j == '$upstream') {</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; j = upstream_domain</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; } else if (j == '$custom_domain') {</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; j = host_name</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; }</span></div><div><span style="font-size: xx-small;">&nbsp;</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; let re = new RegExp(i, 'g')</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; text = text.replace(re, j);</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; }</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; return text;</span></div><div><span style="font-size: xx-small;">}</span></div><div><span style="font-size: xx-small;">&nbsp;</span></div><div><span style="font-size: xx-small;">async function device_status (user_agent_info) {</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; var agents = ["Android", "iPhone", "SymbianOS", "Windows Phone", "iPad", "iPod"];</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; var flag = true;</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; for (var v = 0; v &lt; agents.length; v++) {</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; if (user_agent_info.indexOf(agents[v]) &gt; 0) {</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; flag = false;</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; }</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; }</span></div><div><span style="font-size: xx-small;">&nbsp; &nbsp; return flag;</span></div><div><span style="font-size: xx-small;">}</span></div></div><p><span style="color: #04ff00;">⚠️Deno弄完可以先测试下⚠️</span></p><p><span style="color: red;"><i>Cloudflare workers</i></span>：</p><p><span style="font-size: xx-small;">const upstream = 'ipconst upstream = 'xxx.deno.dev' <span style="color: #ffa400;">//xxx.<i>deno.dev</i>的域名</span></span></p><p><span style="font-size: xx-small;">const upstream_mobile = 'xxx.deno.dev' <span style="color: #ffa400;">//xxx.</span></span><span style="color: #ffa400; font-size: x-small;"><i>deno.de</i>v</span><span style="font-size: xx-small;"><span style="color: #ffa400;">的域名</span></span></p><p><span style="color: #ffa400; font-size: x-small;">//下面的replace_dict里：自定义域名的话xxx.xxx.<i>worker.de</i>v要改成自己的，其它的可以看需求添加</span></p><p><span style="font-size: xx-small;">const replace_dict = {</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; '$upstream': '$custom_domain',</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; '//google.com': '',</span></p><p><span style="font-size: xx-small;">}</span></p><p><span style="font-size: xx-small;">addEventListener('fetch', event =&gt; {</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; event.respondWith(fetchAndApply(event.request));</span></p><p><span style="font-size: xx-small;">})</span></p><p><span style="font-size: xx-small;">async function fetchAndApply(request) {</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; const user_agent = request.headers.get('user-agent');</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; let response = null;</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; let url = new URL(request.url);</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; let url_host = url.host;</span></p><p><span style="font-size: xx-small;">&nbsp;</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; if (await device_status(user_agent)) {</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; var upstream_domain = upstream</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; } else {</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; var upstream_domain = upstream_mobile</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; }</span><span style="font-size: x-small;">&nbsp;</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; url.host = upstream_domain;</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; let method = request.method;</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; let request_headers = request.headers;</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; let new_request_headers = new Headers(request_headers);</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; //url.href=url.href.replace('https://','http://');</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; if (request.method === 'POST') {</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; new_request_headers.set('Host', upstream_domain);</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; new_request_headers.set('Referer', url.href);</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; new_request_headers.set('Origin', "https://"+upstream);</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; var original_response = await fetch(url.href, {</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; method: 'POST',</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; headers: new_request_headers,</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; body : request.body</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; })</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; }</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; else{</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; new_request_headers.set('Host', upstream_domain);</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; new_request_headers.set('Referer', url.href);</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp;&nbsp;</span><span style="font-size: x-small;">&nbsp; &nbsp; var original_response = await fetch(url.href, {</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; method: method,</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; headers: new_request_headers</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; })</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; }</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; let original_response_clone = original_response.clone();</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; let original_text = null;</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; let response_headers = original_response.headers;</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; let new_response_headers = new Headers(response_headers);</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; let status = original_response.status;</span></p><p><span style="font-size: x-small;">&nbsp; &nbsp; new_response_headers.set('access-control-allow-origin', '*');</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; new_response_headers.set('access-control-allow-credentials', true);</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; new_response_headers.delete('content-security-policy');</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; new_response_headers.delete('content-security-policy-report-only');</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; new_response_headers.delete('clear-site-data');</span></p><p><span style="font-size: x-small;">&nbsp; &nbsp; const content_type = new_response_headers.get('content-type');</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; if (content_type==null){original_text = original_response_clone.body}</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; else if (content_type.includes('text/html') &amp;&amp; content_type.includes('UTF-8')) {</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; original_text = await replace_response_text(original_response_clone, upstream_domain, url_host);</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; } else {</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; original_text = original_response_clone.body</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; }</span></p><p><span style="font-size: x-small;">&nbsp; &nbsp; response = new Response(original_text, {</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; status,</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; headers: new_response_headers</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; })</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp;&nbsp;</span><span style="font-size: x-small;">&nbsp; &nbsp; return response;</span></p><p><span style="font-size: x-small;">}</span></p><p><span style="font-size: x-small;">async function replace_response_text(response, upstream_domain, host_name) {</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; let text = await response.text()</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; var i, j;</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; for (i in replace_dict) {</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; j = replace_dict[i]</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; if (i == '$upstream') {</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i = upstream_domain</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; } else if (i == '$custom_domain') {</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i = host_name</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p><span style="font-size: xx-small;">&nbsp;</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; if (j == '$upstream') {</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; j = upstream_domain</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; } else if (j == '$custom_domain') {</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; j = host_name</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p><span style="font-size: xx-small;">&nbsp;</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; let re = new RegExp(i, 'g')</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; text = text.replace(re, j);</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; }</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; return text;</span></p><p><span style="font-size: xx-small;">}</span></p><p><span style="font-size: xx-small;">&nbsp;</span></p><p><span style="font-size: xx-small;">async function device_status (user_agent_info) {</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; var agents = ["Android", "iPhone", "SymbianOS", "Windows Phone", "iPad", "iPod"];</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; var flag = true;</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; for (var v = 0; v &lt; agents.length; v++) {</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; if (user_agent_info.indexOf(agents[v]) &gt; 0) {</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; flag = false;</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; }</span></p><p><span style="font-size: xx-small;">&nbsp; &nbsp; return flag;</span></p><p><span style="font-size: xx-small;">}</span></p><p><br /></p><p><span style="color: red;">⚠️结束</span><span style="color: red;">⚠️</span></p><p>最后，自定义域名，添加一条或多条解析并开启小云朵（A记录CNAME都无所谓瞎填填就行），再设置下域名的Workers Routes。</p><p><br /></p><p><span style="font-size: medium;">美中不足（<span style="color: #ff00fe;">安全性</span>）：</span></p><p>1. 从内网到阿里云：内网穿透：这个<i>NPS</i>协议估计是能被轻松识别了，数据在设置里加不加密都是看得见的，我有测试过。</p><p>2. 阿里云自身：这个估计流量会有几个月记录吧。</p><p>3. 阿里云到<i>Deno</i>：纯http通讯，这个也没办法加域名，阿里云拦截，https域名不知道是否拦截，可能以前测试过，https会发送SNI明文请求，那也是会拦截的。但是可以设置ip证书，有免费的来自<i>zerossl</i>，有效期3个月，acme申请证书可能是支持的，上次在阿里云上没能成功，当时是没IP域名的选项，读了<i>zerossl</i>的文档，没成功，记得文档里就写了域名证书的申请。</p><p>至于跨国传输，这个都心知肚明。</p><p>4. <i>Deno</i>到<i>Cloudflare</i>：至少是有SSL的。但是我使它更安全了，我在<i>Cloudflare</i>发送给<i>Deno</i>的请求头里加了Key值，这样的话如果Key值错误，<i>Deno</i>就不会返回任何内容，这里提到的<span style="color: red; font-size: x-large;"><b>更新</b></span>可以在文章最上面的<i>GitHub</i>链接获取获取。甚至这个Key值是可以是个动态的，每几个小时变一次，从api fetch过来，这会增加CPU Time。其实从内网到<i>Deno</i>也可以这么实现，只不过改原程序确实不方便。</p><p>5. <i>Cloudflare</i>回来：那也是有SSL的，反正我没被墙过。</p><p>6. <i>Deno</i>和<i>Cloudflare</i>自身：感谢免费服务。</p><p>7.&nbsp;让网站只能在<i>Cloudflare</i>的域名那访问：如上文更新所说<i>Deno</i>到<i>Cloudflare</i>这段有验证而且是https的，从Deno开始到用户全是https。Workers这里可以通过判断访问域名来隐藏内容。所以只剩<i>阿里云NPS</i>都还可以访问，这里就不要求了，毕竟SSL在这段都没有。</p><p><span style="font-size: medium;">小感想：</span></p><p>0. 现在国内都转向小程序了，搞这些Web其实没啥用。但是我就是爱好，就是喜欢折腾，弄完有成就感。关于<i>Deno</i>/<i>Workers</i>这类至少我写完这个也不会再弄什么了。</p><p>1.&nbsp;在国外访问国内的东西那是老快了，总感觉防火墙是单向的。</p><p>2.<i> File Browser</i>写的项目就是好，至少对于我的JS-Reverse-Proxy是好的。那几个Blog（<i>WordPress</i>&amp;<i>Typecho</i>）估计是为了防盗。所以设计登录的时候想让别人难搞就多来几个Redirect，就像我现在上课的签到界面，有着这功夫还不如手点的，Redirect链接/参数随便改改，程序就要改，还需要重新抓包。虽然有<i>playwright</i>这种浏览器脚本，但是不能在命令行允许，我要它何用，难道还要给它<i>docker</i>出个桌面环境吗。</p><p>3. 发现国外现在好多免费的通过<i>javascript</i>和<i>typescript</i>在线部署的平台，多的都用不过来，但是每个平台都有略微不同。不过在国内弄这些网页不如弄小程序，因为大多数人只会用微信：前年ProjectBasedLearning，做网页，结果成果展示的时候，我在网页里嵌了统计工具，用的二维码，结果几乎所有人的User agent都是微信，那个例外可能是我测试的时候留下的。</p><p>4. 20220907：关于备案：我看了看备案流程有点复杂。这个国内玩网站服务器完全没办法和欧美比。假设一个欧美学生想要做个网站，可以到<i>eu.org</i>申请个免费域名，免费用<i>Cloudflare</i>，用<i>GitHub</i>等挂网站内容，不要半小时网站就可以上线。也有其它很多的免费项目。假设收费，那速度可更快了，只要用一个汉堡的钱可以开通一个月，服务器的价格和物价比那真是九牛一毛，哪有备案这种东西。<i>DDNS</i>那可更简单了 路由器直接自带，比如华硕，免费的一堆，没有墙的风险。<i>DDNS</i>方案多的，国内就是麻烦多，代理+<i>cloudflare ddns</i>还是很稳的，IP更新挺及时的。</p><p>------------------------------------------------------------------------------------------------------------------------</p><p>之前这些东西写的零零散散，直到现在才发现其实我自己有时候也可能会用到这些出于无奈的方案。就记录下而已。</p><p>以下是我在彻底解决这个问题前，试过的所有方案：</p><p>有的是从别人的博客看来的就直接放链接了，有的内容过于复杂，我也懒得尝试了。</p><p>1. 2022九月左右：国内机器的不带备案访问。<a href="https://www.v2ex.com/t/837913" rel="nofollow" target="_blank">https://www.v2ex.com/t/837913</a>&nbsp;（<a href="https://web.archive.org/web/20221010191435/https://www.v2ex.com/t/837913" target="_blank">Web Archive</a>）</p><p>我要解决的问题：我之前用的<i>cloudflare workers</i>来fetch api的，但是现在网站限制了<i>Cloudflare</i> ip的访问，所以得换机器fetch，其它的比如<i>vue</i>我不会，感觉类别很多，不想弄。所以还是<i>PHP</i>方便，但是我不打算续国外机器了，用处不大。提供1和2的两种方案。</p><div><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjmdvgGXUFGhLfEJd8IYGEIqCvPVhoKmAGSgqbC508qbubE2WJ1KX7Z_PF92s5dU0bTOMhtkPO8Y9u7kURqH5d-OvtTEi41ub4yzXXsqKjMq6nGQKfm3q6bF3x9KY-95l9B_ZYF5hn6LlGEsD4AFbXnx3bLveraxSr6BIYmlPYMV7ruPFPMZ7rfxiyB/s1586/IMG_3644.JPG" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="396" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjmdvgGXUFGhLfEJd8IYGEIqCvPVhoKmAGSgqbC508qbubE2WJ1KX7Z_PF92s5dU0bTOMhtkPO8Y9u7kURqH5d-OvtTEi41ub4yzXXsqKjMq6nGQKfm3q6bF3x9KY-95l9B_ZYF5hn6LlGEsD4AFbXnx3bLveraxSr6BIYmlPYMV7ruPFPMZ7rfxiyB/w491-h396/IMG_3644.JPG" width="491" /></a></div><div class="separator" style="clear: both; text-align: center;"><div class="separator" style="clear: both;"><div class="separator" style="clear: both;"><br /></div><div class="separator" style="clear: both;">用国外服务反代，<i>cf</i> 的 <i>worker</i> 不支持直接解析域名，所以还要嵌套一层代理服务，大致流程：</div><div class="separator" style="clear: both;">User browser &lt; = &gt; <i>Cloudflare dns</i> &lt; = &gt;<i>&nbsp;Cloudflare worker</i> &lt; = &gt; <i>Deno</i> &lt; = &gt;<i> Aliyun</i></div><div><a href="https://dash.deno.com" target="_blank"> https://dash.deno.com </a><br /></div></div><div class="separator" style="clear: both;"><i>deno</i> 代码：</div><div class="separator" style="clear: both;"><i>import { serve } from "https://deno.land/std@0.114.0/http/server.ts";</i></div><div class="separator" style="clear: both;"><i>async function handler(req: Request): Promise&lt;Response&gt; {</i></div><div class="separator" style="clear: both;"><i>// console.log(req.headers);</i></div><div class="separator" style="clear: both;"><i>// console.log(req.method, req.url);</i></div><div class="separator" style="clear: both;"><i>const url = req.url;</i></div><div class="separator" style="clear: both;"><i>const path = url.substring(url.indexOf('.dev') + 4);</i></div><div class="separator" style="clear: both;"><i>return await fetch(`http://your VPS ip:8080${path}`);</i></div><div class="separator" style="clear: both;"><i>}</i></div><div class="separator" style="clear: both;"><i>console.log("Listening on http://localhost:8000");</i></div><div class="separator" style="clear: both;"><i>serve(handler);</i></div></div><div><span>&nbsp;&nbsp; &nbsp;</span>但是<i>Deno</i>不允许VPN&amp;Proxy的。</div><div><br /></div>2. 20220925: 免费的<i>PHP</i>网站建设，（待观察） <i>www.000webhostapp.com</i><p></p><p>这个可以免费建W<i>ordPrees</i>，绑上域名。这玩意太好用了，省得买机器部署<i>PHP</i>了。</p><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgxUBSnW59fCRZmJx6o1GWfNZi5LTvkzsgOoYgtG8BrIjJlxqDsbShYeyEycrykTUkIZCHoUbdEp0yCI7ZWUJW315XH_CNeuBnazm9nigszHCVjiIrlLngt8VwXBnx_FnWebKSfmfHLr8NwtG4Xps0lK_RIVuWpkSr5vQFBjdCvsPIIHHC_Ro0e2O3e/s1974/IMG_3645.JPG" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="183" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgxUBSnW59fCRZmJx6o1GWfNZi5LTvkzsgOoYgtG8BrIjJlxqDsbShYeyEycrykTUkIZCHoUbdEp0yCI7ZWUJW315XH_CNeuBnazm9nigszHCVjiIrlLngt8VwXBnx_FnWebKSfmfHLr8NwtG4Xps0lK_RIVuWpkSr5vQFBjdCvsPIIHHC_Ro0e2O3e/w452-h183/IMG_3645.JPG" width="452" /></a></div><br /><p>（这算是点限制吧，我看他们要求每周要登录下，我到时候看看不登录会怎么样。）不登录也没事。<a href="https://blog.cyfan.top/p/f3eb3ee1.html" target="_blank">移除<i>000webhost</i>右下角Powered by <i>000webhost</i>字样</a>。（&nbsp;<a href="https://web.archive.org/web/20221010190810/https://blog.cyfan.top/p/f3eb3ee1.html" target="_blank">Web Archive</a>）</p><p><br /></p><p>3. 很久以前：<i>PHP</i> 转发，可以结合方案1。如果不行的话就用国内机器+方案一吧。</p><p>&nbsp;<i>&nbsp; &nbsp;</i><i>&lt;?php</i></p><p><i><span>&nbsp;&nbsp; &nbsp;</span>$contents = file_get_contents('https://api.example.com/');</i></p><p><i><span>&nbsp;&nbsp; &nbsp;</span>echo $contents;</i></p><p><i><span>&nbsp;&nbsp; &nbsp;</span>?&gt;</i></p><p><br /></p><p>4. 20220919:&nbsp;<a href="https://ssnhd.com/2022/01/08/blog/" target="_blank">https://ssnhd.com/2022/01/08/blog/</a>&nbsp;<a href="https://web.archive.org/web/20221010191346/https://ssnhd.com/2022/01/08/blog/" target="_blank">Web Archive</a></p><p><span>&nbsp;&nbsp; &nbsp;</span>纯<i>javascript</i>的blog，甚至不需要<i>PHP</i>，直接可以无服务器托管，通用的md格式文章，可以迁移到任何地方。文件可以托管在<i>GitHub</i>，（然后用netlify部署）可以<i>Cloudflare Pages</i>，最后<i>Cloudflare</i>加上cdn和tls，稳定性没得说，域名可以无限添加。</p><p><br /></p><p>5. <i>Blogger</i>国内访问</p><p><span>&nbsp; &nbsp;&nbsp;</span><a href="https://blog.cyfan.top/p/620f3e8d.html" target="_blank">打造一个可国内访问的<i>Blogger</i>（<i>Blogspot</i>）方法</a>&nbsp;（&nbsp;<a href="https://web.archive.org/web/20221010191047/https://blog.cyfan.top/p/620f3e8d.html" target="_blank">Web Archive</a>）由于懒惰加上国内搜索引擎不收录，暂时搁置。</p><p><br /></p><p>6.&nbsp;<i>gcore.com</i> CDN</p><p><span>&nbsp;&nbsp; &nbsp;</span>这是纯记录下，这个CDN有1T每月的免费流量。</p><p><br /></p><p>7. 20221015:&nbsp;<i>CasaOS</i>，一个<i>docker</i>可视化网页部署工具，最近很多人在推，其实和这个文章没什么关系。</p><p>但是国内机器基本上连不上官方仓库的，如果内网有代理的话可以玩玩。</p><p><br /></p><p>8. 20221015: 💡有个想法：突然想到阿里云可以搭虚拟机中机，但是是要换系统吗，最好装软件能直接虚拟，现在内存就用10%，都装了<i>nginx</i>+<i>php</i>+<i>nps</i>+<i>docker</i>了，最简单就是装个<i>winserver</i>+破解的<i>vmware</i>+许多的虚拟机。虽然<i>linux</i>下也有<i>vmware</i>那类软件，一是要先装图形界面，没有web的，二是不好破解。还是现在的方法最好，占用小就小吧，就算装了<i>vmware</i>虚拟机里也不知道装什么。</p><p><span>&nbsp;&nbsp; &nbsp;</span>PVE：</p><p><span>&nbsp; <span>&nbsp;&nbsp; &nbsp;</span>&nbsp;&nbsp;</span><a href="https://www.zjcpi.com/2486.html?btwaf=24263536" target="_blank"><i>Debian 10</i>安装<i>Proxmox VE（PVE）</i>虚拟化管理软件教程</a></p><p><span>&nbsp; <span>&nbsp;&nbsp; &nbsp;</span>&nbsp;&nbsp;</span><a href="https://nbyx.xyz/?p=1261" target="_blank"><i>腾讯云</i>248上海 安装<i>PVE 7.1-5</i> 成功, NAT小鸡批量端口转发也搞定</a></p><p>😂另外，用阿里云转发的<i>ss</i> 在墙外效果非常好，<i>nas</i>里的视频看起来非常顺畅，可能群晖系统自身有压缩。</p><p><br /></p>