---
date: '2022-04-28T14:31:00.010+01:00'
description: ''
published: true
slug: 2022-04-vmesswstlscloudflare-2022-04
tags:
- http://schemas.google.com/blogger/2008/kind#post
- legacy-blogger
time_to_read: 5
title: "nginx+vless+ws+tls(+cloudflare) 2022-04 \u66F4\u65B0"
---

*This was originally posted on blogger [here](https://sheng-jiang.blogspot.com/2022/04/vmesswstlscloudflare-2022-04.html)*.

<p>前言： 是时候更新下了，之前的Vmess再装已经不适用了。这次主要是配合前面有一篇内网穿透+NGINX 做国内无80 443 的 网页转发的，用Cloudflare可以省掉CN2节点的流量。</p><p style="text-align: left;">2022/05/01 补充：我又多装了几次，终于发现之前的问题所在了。之前一直是SSRPLUS可以用，Passwall不能用，配置都是手打的，有一个没让我注意到的点<b>Passwall配置的时候&nbsp;<span style="color: red;">tls下的alpn是要填http/1.1</span>&nbsp; 不然会出现malformed http response</b></p><p style="text-align: left;">这样子之前的vmess的搭建步骤还是有效的。属实是愚钝了。</p><p><br /></p><p>这次又需要ws+tls，就再记录下。这次用vless了，vmess一直不成功，应该是版本的原因。</p><p>&nbsp;0. 简单的步骤</p><p>&nbsp;0.1 可能更改VPS系统时间&nbsp;</p><ol class="linenums"><li class="L0" style="background-color: #2f3640; border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px 0px 0px 0.5em; vertical-align: baseline;"><span class="pln" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">rm </span><span class="pun" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">-</span><span class="pln" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">rf </span><span class="pun" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">/</span><span class="pln" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">etc</span><span class="pun" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">/</span><span class="pln" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">localtime</span></li><li class="L1" style="background-color: #2f3640; border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px 0px 0px 0.5em; vertical-align: baseline;"><span class="pln" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">ln </span><span class="pun" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">-</span><span class="pln" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">s </span><span class="pun" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">/</span><span class="pln" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">usr</span><span class="pun" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">/</span><span class="pln" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">share</span><span class="pun" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">/</span><span class="pln" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">zoneinfo</span><span class="pun" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">/</span><span class="typ" style="border: 0px; color: #4fc1e9; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">Asia</span><span class="pun" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">/</span><span class="typ" style="border: 0px; color: #4fc1e9; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">Shanghai</span><span class="pln" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;"> </span><span class="pun" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">/</span><span class="pln" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">etc</span><span class="pun" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">/</span><span class="pln" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">localtime</span></li></ol><p>&nbsp;0.2 安装下lnmp，参考<i>lnmp.org</i>。需要BBR也就装下。</p><p>&nbsp;1. 安装v2ray：https://github.com/v2fly/fhs-install-v2ray</p><p>&nbsp;2. 用whereis v2ray 查看配置文件地址，因为他们也喜欢换来换去。</p><p>&nbsp;3. vi config.json 修改下配置文件</p><pre class="prettyprint linenums prettyprinted" style="background: rgb(47, 54, 64); border-radius: 3px; border: 0px; line-height: 1.6; margin-bottom: 1.2em; margin-top: 0px; overflow: scroll hidden; padding: 1.5em 1.5em 1.5em 50px; vertical-align: baseline; width: 922px;"><ol class="linenums" style="border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;"><li class="L0" style="border: 0px; margin: 0px; padding: 0px 0px 0px 0.5em; vertical-align: baseline;"><span style="color: #e6e9ed; font-family: Courier 10 Pitch, Courier, monospace;"><span style="font-size: 15px;">{<br />  "inbounds": [<br />    {<br />      "port": 65432,<br />      "listen":"127.0.0.1",<br />      "protocol": "vless",<br />      "settings": {<br />        "decryption": "none",<br />        "clients": [<br />          {<br />            "id": "1bb83c10-911e-4767-81d2-adb5177c0718",<br />            "level": 0<br />          }<br />        ]<br />      },<br />      "streamSettings": {<br />        "network": "ws",<br />        "wsSettings": {<br />        "path": "/5e60be4f39c63c/"<br />        }<br />      }<br />    }<br />  ],<br />  "outbounds": [<br />    {<br />      "protocol": "freedom",<br />      "settings": {}<br />    }<br />  ]<br />}<br /></span></span></li><li></li><li></li></ol></pre><p><span style="color: #e6e9ed; font-family: Courier 10 Pitch, Courier, monospace;"><span style="font-size: 15px; white-space: pre;">4. v2ray相关命令</span></span></p><pre><code class="lang-shell"><strike>service v2ray restart  <br />service v2ray status</strike></code></pre><pre><code class="lang-shell"><span style="color: #333333; font-family: Consolas, Liberation Mono, Menlo, Courier, monospace;"><span style="font-size: 13.6px; letter-spacing: 0.2px;">systemctl start v2ray<br /><br />systemctl status v2ray<br /></span></span></code></pre><div><code class="lang-shell"><span style="color: #333333; font-family: Consolas, Liberation Mono, Menlo, Courier, monospace;"><br /></span></code></div><pre><code class="lang-shell"><span style="color: #333333; font-family: Consolas, Liberation Mono, Menlo, Courier, monospace;">systemctl enable v2ray #开启启动</span></code></pre><p>5. Nginx配置</p><ol class="linenums"><li class="L0" style="background-color: #2f3640; border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px 0px 0px 0.5em; vertical-align: baseline;"><span class="pln" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">location </span><span class="pun" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">/</span>5e60be4f39c63c/<span class="pln" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;"> </span><span class="pun" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">{</span></li><li class="L1" style="background-color: #2f3640; border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px 0px 0px 0.5em; vertical-align: baseline;"><span class="kwd" style="border: 0px; color: #4fc1e9; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">if</span><span class="pln" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;"> </span><span class="pun" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">(</span><span class="pln" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">$http_upgrade </span><span class="pun" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">!=</span><span class="pln" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;"> </span><span class="str" style="border: 0px; color: #ffce54; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">"websocket"</span><span class="pun" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">)</span><span class="pln" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;"> </span><span class="pun" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">{</span><span class="pln" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;"> </span></li><li class="L2" style="background-color: #2f3640; border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px 0px 0px 0.5em; vertical-align: baseline;"><span class="pln" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">        </span><span class="kwd" style="border: 0px; color: #4fc1e9; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">return</span><span class="pln" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;"> </span><span class="lit" style="border: 0px; color: #ac92ec; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">404</span><span class="pun" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">;</span></li><li class="L3" style="background-color: #2f3640; border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px 0px 0px 0.5em; vertical-align: baseline;"><span class="pln" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">    </span><span class="pun" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">}</span></li><li class="L4" style="background-color: #2f3640; border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px 0px 0px 0.5em; vertical-align: baseline;"><span class="pln" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">    proxy_redirect off</span><span class="pun" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">;</span></li><li class="L5" style="background-color: #2f3640; border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px 0px 0px 0.5em; vertical-align: baseline;"><span class="pln" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">    proxy_pass http</span><span class="pun" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">:</span><span class="com" style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">//127.0.0.1:65432; </span></li><li class="L6" style="background-color: #2f3640; border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px 0px 0px 0.5em; vertical-align: baseline;"><span class="pln" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">    proxy_http_version </span><span class="lit" style="border: 0px; color: #ac92ec; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">1.1</span><span class="pun" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">;</span></li><li class="L7" style="background-color: #2f3640; border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px 0px 0px 0.5em; vertical-align: baseline;"><span class="pln" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">    proxy_set_header </span><span class="typ" style="border: 0px; color: #4fc1e9; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">Upgrade</span><span class="pln" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;"> $http_upgrade</span><span class="pun" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">;</span></li><li class="L8" style="background-color: #2f3640; border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px 0px 0px 0.5em; vertical-align: baseline;"><span class="pln" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">    proxy_set_header </span><span class="typ" style="border: 0px; color: #4fc1e9; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">Connection</span><span class="pln" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;"> </span><span class="str" style="border: 0px; color: #ffce54; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">"upgrade"</span><span class="pun" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">;</span></li><li class="L9" style="background-color: #2f3640; border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px 0px 0px 0.5em; vertical-align: baseline;"><span class="pln" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">    proxy_set_header </span><span class="typ" style="border: 0px; color: #4fc1e9; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">Host</span><span class="pln" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;"> $host</span><span class="pun" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">;</span></li><li class="L0" style="background-color: #2f3640; border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px 0px 0px 0.5em; vertical-align: baseline;"><span class="pln" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">    </span><span class="com" style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;"># Show real IP in v2ray access.log</span></li><li class="L1" style="background-color: #2f3640; border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px 0px 0px 0.5em; vertical-align: baseline;"><span class="pln" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">    proxy_set_header X</span><span class="pun" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">-</span><span class="typ" style="border: 0px; color: #4fc1e9; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">Real</span><span class="pun" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">-</span><span class="pln" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">IP $remote_addr</span><span class="pun" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">;</span></li><li class="L2" style="background-color: #2f3640; border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px 0px 0px 0.5em; vertical-align: baseline;"><span class="pln" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">    proxy_set_header X</span><span class="pun" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">-</span><span class="typ" style="border: 0px; color: #4fc1e9; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">Forwarded</span><span class="pun" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">-</span><span class="typ" style="border: 0px; color: #4fc1e9; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">For</span><span class="pln" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;"> $proxy_add_x_forwarded_for</span><span class="pun" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">;</span></li><li class="L7" style="background-color: #2f3640; border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px 0px 0px 0.5em; vertical-align: baseline;"><span class="pun" style="border: 0px; color: #e6e9ed; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; padding: 0px; vertical-align: baseline;">}</span></li></ol><p>6. SSL配置下 Cloudflare IP优选</p><p>https://github.com/XIU2/CloudflareSpeedTest/releases</p><p>7.可能有其它问题，也写在Blog里了。</p><p><br /></p>